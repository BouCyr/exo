<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonjour!</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100dvh;
            margin: 0;
            background-color: #000;
            color: #fff;
            position: relative;
            padding-top: 5rem;
            box-sizing: border-box;
        }
        #score-container {
            position: fixed;
            top: 1rem;
            left: 0;
            right: 0;
            z-index: 10;
            font-size: 1.5rem;
            font-family: 'Roboto Mono', monospace;
            display: none;
            text-align: center;
            color: #fff;
            transition: color 0.5s ease, text-shadow 0.5s ease;
            text-shadow: 
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px #00ffff,
                0 0 30px #00ffff,
                0 0 40px #00ffff,
                0 0 55px #00ffff,
                0 0 75px #00ffff;
        }
        /* Neon Colors */
        .neon-blue {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #00ffff, 0 0 30px #00ffff, 0 0 40px #00ffff, 0 0 55px #00ffff, 0 0 75px #00ffff !important;
        }
        .neon-pink {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00ff, 0 0 30px #ff00ff, 0 0 40px #ff00ff, 0 0 55px #ff00ff, 0 0 75px #ff00ff !important;
        }
        .neon-yellow {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ffff00, 0 0 30px #ffff00, 0 0 40px #ffff00, 0 0 55px #ffff00, 0 0 75px #ffff00 !important;
        }
        .neon-green {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #39ff14, 0 0 30px #39ff14, 0 0 40px #39ff14, 0 0 55px #39ff14, 0 0 75px #39ff14 !important;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }
        #history {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 1rem;
        }
        .line {
            display: grid;
            grid-template-columns: 3.5rem 1.5rem 3.5rem 1.5rem 4.5rem;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-family: 'Roboto Mono', monospace;
            width: 100%;
        }
        .line.fade-out {
            display: none;
        }
        .question {
            text-align: center;
            white-space: pre;
        }
        .input-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        input {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.5rem;
            width: 100%;
            padding: 0;
            text-align: center;
            border: 2px solid #444;
            background: #222;
            color: #fff;
            border-radius: 0.5rem;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input:focus {
            outline: none;
            border-color: #4a90e2;
        }
        input:read-only {
            border-color: transparent;
            background: transparent;
            color: #39ff14;
            font-weight: bold;
            text-shadow: 0 0 5px #39ff14;
        }
        .message {
            height: 2rem;
            font-weight: bold;
            margin-top: 1rem;
            font-family: 'Roboto Mono', monospace;
            font-size: 1.2rem;
        }
        .success {
            color: #39ff14;
            text-shadow: 0 0 5px #39ff14;
        }
        .error {
            color: #dc3545;
        }
        #install-button {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            background: #000;
            color: #00ffff;
            border: 2px solid #00ffff;
            padding: 0.8rem 1.5rem;
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            border-radius: 2rem;
            cursor: pointer;
            z-index: 100;
            text-shadow: 0 0 5px #00ffff;
            box-shadow: 0 0 10px #00ffff, inset 0 0 5px #00ffff;
            transition: all 0.3s ease;
        }
        #install-button:active {
            transform: translateX(-50%) scale(0.95);
            box-shadow: 0 0 20px #00ffff, inset 0 0 10px #00ffff;
        }
    </style>
</head>
<body>
    <div id="score-container"></div>
    <button id="install-button">Installer l'application</button>
    <div class="container">
        <div id="history"></div>
        <div class="message" id="message"></div>
    </div>

    <script>
        let MULTIPLICATION_LIMIT = 5;
        let ADDITION_LIMIT = 10;

        // Load limits from localStorage if available
        const savedLimits = localStorage.getItem('game-limits');
        if (savedLimits) {
            try {
                const parsed = JSON.parse(savedLimits);
                MULTIPLICATION_LIMIT = parsed.MULTIPLICATION_LIMIT || 5;
                ADDITION_LIMIT = parsed.ADDITION_LIMIT || 10;
            } catch (e) {
                console.error("Failed to parse saved limits", e);
            }
        }

        async function fetchLimits() {
            try {
                const response = await fetch('./limits.json');
                if (response.ok) {
                    const data = await response.json();
                    MULTIPLICATION_LIMIT = data.MULTIPLICATION_LIMIT || 5;
                    ADDITION_LIMIT = data.ADDITION_LIMIT || 10;
                    localStorage.setItem('game-limits', JSON.stringify(data));
                }
            } catch (e) {
                // Silently fail as requested
                console.log("Failed to fetch remote limits, using local/default ones.");
            }
        }

        fetchLimits();
        const historyContainer = document.getElementById('history');
        const messageElement = document.getElementById('message');
        const scoreContainer = document.getElementById('score-container');
        const installButton = document.getElementById('install-button');
        let deferredPrompt;

        const scoreMessages = [
            "Super ! {n} victoires !",
            "Bravo ! Déjà {n} points !",
            "Championne ! {n} réussis !",
            "Génial ! Score : {n} !",
            "Top ! Tu en as {n} !",
            "Incroyable ! {n} d'affilée !",
            "Extra ! {n} bonnes réponses !",
            "Magnifique ! {n} dans la poche !",
            "Trop forte ! Déjà {n} !",
            "Waouh ! {n} et ça continue !"
        ];

        const neonClasses = ['neon-blue', 'neon-pink', 'neon-yellow', 'neon-green'];

        let expectedValue = 0;
        let activeInput = null;
        let score = 0;
        let audioCtx = null;

        function playDing() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const now = audioCtx.currentTime;

            function playNote(freq, start, duration, volume) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc.type = 'triangle'; // Milder than saw, richer than sine
                osc.frequency.setValueAtTime(freq, start);
                osc.frequency.exponentialRampToValueAtTime(freq * 1.05, start + duration);

                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(volume, start + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, start + duration);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start(start);
                osc.stop(start + duration);
            }

            // Upbeat "da-ding!" sound
            playNote(523.25, now, 0.15, 0.15); // C5
            playNote(783.99, now + 0.1, 0.3, 0.2); // G5
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW registered!', reg);
                        // Check for updates
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available, reload the page
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }

        function updateScore() {
            score++;
            const msgTemplate = scoreMessages[(score - 1) % scoreMessages.length];
            scoreContainer.textContent = msgTemplate.replace('{n}', score);
            
            // Cycle neon colors
            scoreContainer.className = neonClasses[(score - 1) % neonClasses.length];

            if (score > 0) {
                scoreContainer.style.display = 'block';
            }
        }

        function generateQuestion() {
            // Keep only last 3 lines if we are about to add a 4th
            const lines = historyContainer.querySelectorAll('.line');
            if (lines.length >= 4) {
                lines[0].remove();
            }

            // Randomly choose operation: 0: Multiplication, 1: Addition
            const isAddition = Math.random() < 0.5;
            let a, b, result, operator;

            if (isAddition) {
                a = Math.floor(Math.random() * ADDITION_LIMIT) + 1;
                b = Math.floor(Math.random() * ADDITION_LIMIT) + 1;
                result = a + b;
                operator = '+';
            } else {
                a = Math.floor(Math.random() * MULTIPLICATION_LIMIT) + 1;
                b = Math.floor(Math.random() * 10) + 1;
                result = a * b;
                operator = 'x';
            }

            const aStr = a.toString().padStart(2, ' ');
            const bStr = b.toString().padStart(2, ' ');
            const resStr = result.toString().padStart(2, ' ');

            // Question types: 0: a op b = ?, 1: ? op b = res, 2: a op ? = res
            // Weights: type 0 is 3x more frequent (3/5), others 1/5 each
            const typePool = [0, 0, 0, 1, 2];
            const type = typePool[Math.floor(Math.random() * typePool.length)];

            const lineDiv = document.createElement('div');
            lineDiv.className = 'line';

            const part1 = document.createElement('div');
            part1.className = 'question';
            const part2 = document.createElement('div');
            part2.className = 'question';
            part2.textContent = operator;
            const part3 = document.createElement('div');
            part3.className = 'question';
            const part4 = document.createElement('div');
            part4.className = 'question';
            part4.textContent = '=';
            const part5 = document.createElement('div');
            part5.className = 'question';

            const wrapper = document.createElement('div');
            wrapper.className = 'input-wrapper';
            const input = document.createElement('input');
            input.type = 'number';
            input.inputMode = 'numeric';
            input.placeholder = '?';
            input.autofocus = true;
            wrapper.appendChild(input);

            if (type === 0) {
                part1.textContent = aStr;
                part3.textContent = bStr;
                part5.appendChild(wrapper);
                expectedValue = result;
            } else if (type === 1) {
                part1.appendChild(wrapper);
                part3.textContent = bStr;
                part5.textContent = resStr;
                expectedValue = a;
            } else {
                part1.textContent = aStr;
                part3.appendChild(wrapper);
                part5.textContent = resStr;
                expectedValue = b;
            }

            lineDiv.appendChild(part1);
            lineDiv.appendChild(part2);
            lineDiv.appendChild(part3);
            lineDiv.appendChild(part4);
            lineDiv.appendChild(part5);
            
            historyContainer.appendChild(lineDiv);

            input.focus();
            activeInput = input;

            input.addEventListener('input', () => {
                const val = parseInt(input.value);
                if (val === expectedValue) {
                    playDing();
                    messageElement.textContent = 'Bravo !';
                    messageElement.className = 'message success';
                    input.readOnly = true;
                    updateScore();
                    
                    // Generate next question immediately to avoid losing focus
                    generateQuestion();
                    
                    setTimeout(() => {
                        messageElement.textContent = '';
                    }, 400);
                }
            });
        }

        // Initial question
        generateQuestion();

        // Handle PWA installation
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI notify the user they can add to home screen
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', (e) => {
            // hide our user interface that shows our A2HS button
            installButton.style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });

        window.addEventListener('appinstalled', (event) => {
            console.log('App was installed');
            installButton.style.display = 'none';
        });
    </script>
</body>
</html>